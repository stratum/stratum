<!--
Copyright 2022-present Open Networking Foundation

SPDX-License-Identifier: Apache-2.0
-->

# Stratum P4 Role Configuration

Stratum supports the [P4Runtime Role Configuration](https://p4.org/p4-spec/p4runtime/main/P4Runtime-Spec.html#sec-arbitration-role-config)
feature, with a similar implementation set as described in the specification.

Stratum's role config description is protobuf based and can be found under
[stratum/public/proto/p4_role_config.proto](/stratum/public/proto/p4_role_config.proto).
In particular, it allows a given role to:
- restrict r/w access to a subset of P4 entities, identified by their ID
- enable or disable receipt of `PacketIn` messages
- filter PacketIn messages based on their `PacketMetadata`
- enable or disable ability to push a new pipeline

## Example workflow using `P4RoleConfig`

This section shows how to pack and push a role configuration into Stratum in
practice. If Bazel is used, the role config proto can be imported as a
dependency as follows:

```python
# BUILD

load("@rules_cc//cc:defs.bzl", "cc_proto_library", "cc_binary")

cc_proto_library(
    name = "p4_role_config_cc_proto",
    deps = ["@com_github_stratum_stratum//stratum/public/proto:p4_role_config_proto"],
)

cc_binary(
    name = "main",
    srcs = ["main.cc"],
    deps = [":p4_role_config_cc_proto"],
)
```

Below is an example role configuration, stored somewhere on disk as
`role_config.pb.txt`:

```textproto
exclusive_p4_ids: 100
exclusive_p4_ids: 200
packet_in_filter {
  metadata_id: 300
  value: "foo"
}
receives_packet_ins: true
can_push_pipeline: true
```

When the `protoc` compiled protobuf definitions are available, the config can
easily be packed into the `Any` field of the P4Runtime `MasterArbitrationUpdate`
message like in the snippet below:

```c++
#include "stratum/public/proto/p4_role_config.pb.h"

std::string role_name = "foo_role";
P4RoleConfig role_config;
RETURN_IF_ERROR(ReadProtoFromTextFile("/path/to/role_config.pb.txt", &role_config));
::p4::v1::MasterArbitrationUpdate arbitration;
arbitration.mutable_role()->set_name(role_name);
arbitration.mutable_role()->mutable_config()->PackFrom(role_config);
```

### Manually packing the `Any` message

In some situations the autogenerated message APIs for `P4RoleConfig` might not
be available. As long as the role config is present **in its binary form**,
i.e., when packaged externally, it can still be packed into an `Any` message
manually. Setting the type URL to `"type.googleapis.com/stratum.P4RoleConfig"`
and the serialized config as the value results in an identical `Any` message.
Below is an example for C++, but other languages will provide similar APIs.

```c++
P4RoleConfig role_config;
role_config.add_exclusive_p4_ids(1);
role_config.set_can_push_pipeline(true);

::google::protobuf::Any a;
a.set_type_url("type.googleapis.com/stratum.P4RoleConfig");
a.set_value(role_config.SerializeAsString());  // Bytes could also come from disk.

::google::protobuf::Any b;
b.PackFrom(role_config);

CHECK(ProtoEqual(a, b));  // True
```
